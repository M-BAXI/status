name: Maintenance Email Notifications

on:
  issues:
    types: [opened, edited, reopened, closed, labeled]
  workflow_dispatch:

permissions:
  contents: read
  issues: read

jobs:
  send-email:
    # åªåœ¨ issues äº‹ä»¶å¹¶ä¸”æ ‡é¢˜æ­£ç¡®æ—¶æ‰§è¡Œ
    if: github.event.issue && startsWith(github.event.issue.title, '[Scheduled Maintenance]')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Extract maintenance info (with extension detection)
        id: maint
        uses: actions/github-script@v7
        with:
          script: |
            const payload = context.payload;
            if (!payload.issue) {
              core.setFailed("å½“å‰è§¦å‘äº‹ä»¶æ²¡æœ‰ issue å¯¹è±¡ï¼Œåªæ”¯æŒ issues äº‹ä»¶è§¦å‘ã€‚");
              return;
            }

            const issue = payload.issue;
            const body = issue.body || "";

            // è§£æ KV æ³¨é‡Šå—
            const parseKV = (text) => {
              const m = (text || "").match(/<!--([\s\S]*?)-->/);
              const kv = { start: "", end: "", expectedDown: "", expectedDegraded: "" };
              if (!m) return kv;
              for (const line of m[1].split("\n")) {
                const mm = line.match(/^\s*([a-zA-Z]+)\s*:\s*(.+?)\s*$/);
                if (!mm) continue;
                const k = mm[1], v = mm[2];
                if (kv.hasOwnProperty(k)) kv[k] = v;
              }
              return kv;
            };

            const newKV   = parseKV(body);
            const oldBody = payload.changes?.body?.from || "";
            const oldKV   = parseKV(oldBody);

            // å¯è§æ­£æ–‡
            let visible = body.replace(/<!--[\s\S]*?-->/g, "").trim();
            const ctxMatch = visible.match(/\*\*Additional context\*\*([\s\S]*)$/i);
            const contextText = (ctxMatch ? ctxMatch[1] : visible).trim();

            const normList = (s) =>
              (s || "").split(/[,\n]/).map(x => x.trim()).filter(Boolean);

            const downList     = normList(newKV.expectedDown);
            const degradedList = normList(newKV.expectedDegraded);

            // åˆ¤å®šæ¨¡å¼
            let mode = "start"; // start | extended_changed | extended_label | finished
            let previousEnd = "";
            const action = payload.action;

            if (action === "closed") {
              mode = "finished";
            } else if (action === "edited") {
              if (newKV.end && oldKV.end && newKV.end !== oldKV.end) {
                mode = "extended_changed";
                previousEnd = oldKV.end;
              }
            } else if (action === "labeled") {
              const lbl = (payload.label?.name || "").toLowerCase();
              if (lbl === "extended") mode = "extended_label";
            }

            // é‚®ä»¶æ¨¡æ¿æ–‡æœ¬
            let subjectPrefix = "ğŸ”§ æœåŠ¡ç³»ç»Ÿç»´æŠ¤é€šçŸ¥";
            let introLine     = "æœåŠ¡å°†äºä»¥ä¸‹æ—¶é—´è¿›è¡Œç»´æŠ¤ï¼š";
            let tailLine      = "å¦‚é‡ä¸å¯é¢„è®¡çš„é—®é¢˜ï¼Œç»´æŠ¤æ—¶é—´å°†ä¼šå»¶é•¿ï¼Œå…·ä½“å»¶è¯¯æ—¶é—´å°†å¦è¡Œé€šçŸ¥ã€‚";

            if (mode === "extended_changed") {
              subjectPrefix = "âš ï¸ ç»´æŠ¤å»¶é•¿é€šçŸ¥";
              introLine     = `ç»´æŠ¤æ—¶é—´å·²å»¶é•¿ï¼šåŸè®¡åˆ’ç»“æŸ ${previousEnd} â†’ å»¶é•¿è‡³ ${newKV.end}`;
              tailLine      = "è¯·æ³¨æ„ï¼Œç»´æŠ¤çª—å£æ¯”åŸè®¡åˆ’æ›´é•¿ï¼Œå¯èƒ½ç»§ç»­å½±å“éƒ¨åˆ†æœåŠ¡ã€‚";
            } else if (mode === "extended_label") {
              subjectPrefix = "âš ï¸ ç»´æŠ¤å»¶é•¿é€šçŸ¥";
              introLine     = "ç»´æŠ¤æ—¶é—´å·²å»¶é•¿ï¼Œå½“å‰å»¶è¯¯æ—¶é•¿å¾…å®šï¼š";
              tailLine      = "æˆ‘ä»¬ä¼šåœ¨ç¡®å®šæ–°çš„ç»“æŸæ—¶é—´åç¬¬ä¸€æ—¶é—´é€šçŸ¥ã€‚";
            } else if (mode === "finished") {
              subjectPrefix = "âœ… ç»´æŠ¤å®Œæˆé€šçŸ¥";
              introLine     = "ä»¥ä¸‹ç»´æŠ¤ä»»åŠ¡å·²å®Œæˆï¼ŒæœåŠ¡æ¢å¤æ­£å¸¸ï¼š";
              tailLine      = "âœ… æ‰€æœ‰æœåŠ¡å·²æ¢å¤æ­£å¸¸è¿è¡Œï¼Œæ„Ÿè°¢ç†è§£ä¸é…åˆï¼";
            }

            // è¾“å‡º
            core.setOutput("mode", mode);
            core.setOutput("subject_prefix", subjectPrefix);
            core.setOutput("intro_line", introLine);
            core.setOutput("tail_line", tailLine);

            core.setOutput("issue_title", issue.title);
            core.setOutput("start", newKV.start || "ï¼ˆæœªæŒ‡å®šï¼‰");
            core.setOutput("end",   newKV.end   || "ï¼ˆæœªæŒ‡å®šï¼‰");
            core.setOutput("prev_end", previousEnd || "ï¼ˆæ— ï¼‰");
            core.setOutput("down",     downList.length ? downList.join(", ") : "æ— ");
            core.setOutput("degraded", degradedList.length ? degradedList.join(", ") : "æ— ");
            core.setOutput("context",  contextText || "ï¼ˆæ— è¡¥å……è¯´æ˜ï¼‰");

      - name: Send email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.163.com
          server_port: 465
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASS }}
          to: "bryanyijies@qq.com"
          from: "Adoremont IT Service <${{ secrets.SMTP_USER }}>"
          subject: "${{ steps.maint.outputs.subject_prefix }}ï½œ${{ steps.maint.outputs.issue_title }}"
          body: |
            å„ä½å¥½ï¼Œ

            ${{ steps.maint.outputs.intro_line }}

            æ ‡é¢˜ï¼š${{ steps.maint.outputs.issue_title }}
            å¼€å§‹ï¼š${{ steps.maint.outputs.start }}
            ç»“æŸï¼š${{ steps.maint.outputs.end }}
            ${{ steps.maint.outputs.mode == 'extended_changed' && format('åŸè®¡åˆ’ç»“æŸï¼š{0}', steps.maint.outputs.prev_end) || '' }}

            å—å½±å“æœåŠ¡ï¼š
            - é¢„è®¡ä¸å¯ç”¨ï¼ˆdownï¼‰ï¼š${{ steps.maint.outputs.down }}
            - é¢„è®¡é™çº§ï¼ˆdegradedï¼‰ï¼š${{ steps.maint.outputs.degraded }}

            ç»´æŠ¤è¯´æ˜ï¼š
            ${{ steps.maint.outputs.context }}

            ${{ steps.maint.outputs.tail_line }}
